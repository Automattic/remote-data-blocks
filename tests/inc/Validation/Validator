<?php

namespace RemoteDataBlocks\Tests\Validation;

use PHPUnit\Framework\TestCase;
use RemoteDataBlocks\WpdbStorage\DatasourceCrud;
use RemoteDataBlocks\Validation\DatasourceValidator;
use RemoteDataBlocks\Validation\DatasourceValidatorInterface;
use RemoteDataBlocks\Validation\ValidatorInterface;
use WP_Error;


class ValidatorTest extends TestCase {
    public function test_validate_airtable_source_with_valid_input() {
		$valid_source = (object) [
			'uuid'    => '123e4567-e89b-12d3-a456-426614174000',
			'token'   => 'valid_token',
			'service' => 'airtable',
			'base'    => [
				'id'   => 'base_id',
				'name' => 'Base Name',
			],
			'table'   => [
				'id'   => 'table_id',
				'name' => 'Table Name',
			],
			'slug'    => 'valid-slug',
		];

		$result = DatasourceCrud::validate_airtable_source( $valid_source );
		$this->assertIsObject( $result );
		$this->assertSame( $valid_source->uuid, $result->uuid );
	}

	public function test_validate_airtable_source_with_invalid_input() {
		$invalid_source = (object) [
			'uuid'    => '123e4567-e89b-12d3-a456-426614174000',
			'service' => 'airtable',
			'slug'    => 'valid-slug',
		];

		$this->assertInstanceOf( WP_Error::class, DatasourceCrud::validate_airtable_source( $invalid_source ) );
	}

	public function test_validate_shopify_source_with_valid_input() {
		$valid_source = (object) [
			'uuid'    => '123e4567-e89b-12d3-a456-426614174000',
			'token'   => 'valid_token',
			'service' => 'shopify',
			'store'   => 'mystore.myshopify.com',
			'slug'    => 'valid-slug',
		];

		$result = DatasourceCrud::validate_shopify_source( $valid_source );
		$this->assertIsObject( $result );
		$this->assertSame( $valid_source->uuid, $result->uuid );
	}

	public function test_validate_shopify_source_with_invalid_input() {
		$invalid_source = (object) [
			'uuid'    => '123e4567-e89b-12d3-a456-426614174000',
			'service' => 'shopify',
			'slug'    => 'valid-slug',
		];

		$this->assertInstanceOf( WP_Error::class, DatasourceCrud::validate_shopify_source( $invalid_source ) );
	}

	public function test_validate_google_sheets_source_with_valid_input() {
		$valid_credentials = [
			'type'                        => 'service_account',
			'project_id'                  => 'test-project',
			'private_key_id'              => '1234567890abcdef',
			'private_key'                 => '-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQC7/jHh2Wo0zkA5\n-----END PRIVATE KEY-----\n',
			'client_email'                => 'test@test-project.iam.gserviceaccount.com',
			'client_id'                   => '123456789012345678901',
			'auth_uri'                    => 'https://accounts.google.com/o/oauth2/auth',
			'token_uri'                   => 'https://oauth2.googleapis.com/token',
			'auth_provider_x509_cert_url' => 'https://www.googleapis.com/oauth2/v1/certs',
			'client_x509_cert_url'        => 'https://www.googleapis.com/robot/v1/metadata/x509/test%40test-project.iam.gserviceaccount.com',
			'universe_domain'             => 'googleapis.com',
		];

		$valid_source = (object) [
			'uuid'        => '123e4567-e89b-12d3-a456-426614174000',
			'service'     => 'google-sheets',
			'credentials' => $valid_credentials,
			'spreadsheet' => [
				'id'   => 'spreadsheet_id',
				'name' => 'Spreadsheet Name',
			],
			'sheet'       => [
				'id'   => 0,
				'name' => 'Sheet Name',
			],
			'slug'        => 'valid-slug',
		];

		$result = DatasourceCrud::validate_google_sheets_source( $valid_source );
		$this->assertIsObject( $result );
		$this->assertSame( $valid_source->uuid, $result->uuid );
	}

	public function test_validate_google_sheets_source_with_invalid_input() {
		$invalid_source = (object) [
			'uuid'        => '123e4567-e89b-12d3-a456-426614174000',
			'service'     => 'google-sheets',
			'credentials' => [],
			'slug'        => 'valid-slug',
		];

		$this->assertInstanceOf( WP_Error::class, DatasourceCrud::validate_google_sheets_source( $invalid_source ) );
	}


	public function test_validate_source_with_valid_input() {
		$valid_source = (object) [
			'uuid'    => '123e4567-e89b-12d3-a456-426614174000',
			'token'   => 'valid_token',
			'service' => 'airtable',
			'base'    => [
				'id'   => 'base_id',
				'name' => 'Base Name',
			],
			'table'   => [
				'id'   => 'table_id',
				'name' => 'Table Name',
			],
			'slug'    => 'valid-slug',
		];

		$result = DatasourceCrud::validate_source( $valid_source );
		$this->assertIsObject( $result );
		$this->assertObjectHasProperty( 'uuid', $result );
		$this->assertSame( $valid_source->uuid, $result->uuid );
	}

	public function test_validate_source_with_invalid_input() {
		$invalid_source = (object) [
			'uuid'    => 'invalid-uuid',
			'service' => 'unsupported',
			'slug'    => 'valid-slug',
		];

		$result = DatasourceCrud::validate_source( $invalid_source );
		$this->assertInstanceOf( WP_Error::class, $result );
		$this->assertSame( 'invalid_uuid', $result->get_error_code() );
	}
